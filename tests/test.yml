---
- name: Test jenkins service   
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    jenkins_hostname: 127.0.0.1
    jenkins_http_port: 8080
    jenkins_jar_location: /opt/jenkins-cli.jar
  vars_files:
    - test_var.yml
  tasks:
    - name: Wait for service to be available
      wait_for:
        host: "{{ jenkins_hostname }}"
        port: "{{ jenkins_http_port }}"
        delay: 20
        timeout: 120 
      ignore_errors: yes

    - name: Get the jenkins-cli jarfile from the Jenkins server.
      get_url:
        url: "http://{{ jenkins_hostname }}:{{ jenkins_http_port }}/jnlpJars/jenkins-cli.jar"
        dest: "{{ jenkins_jar_location }}"
      register: jarfile_get
      until: "'OK' in jarfile_get.msg or 'file already exists' in jarfile_get.msg"
      retries: 15
      delay: 20


    - shell: java -jar {{ jenkins_jar_location }} -s http://{{ jenkins_hostname }}:{{ jenkins_http_port }}{{ jenkins_url_prefix | default('') }}/ list-plugins  --username {{ JENKINS_ADMIN_USERNAME }} --password {{ JENKINS_ADMIN_PASSWORD }}
      register: out
      until: out.stdout.find("greenball") != -1
      retries: 5
      delay: 10

    - assert:
        that: out.stdout.find("greenball") != -1
